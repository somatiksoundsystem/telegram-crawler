name: Docker Deploy Production

on:
  push:
    branches: [ "master" ]
    # Publish semver tags as releases.
    tags: [ 'v*.*.*' ]

concurrency: serial

env:
  CONTEXT_NAME: "remote"

jobs:
  deploy:
    name: 'Publish on the development server'

    runs-on: ubuntu-latest

    environment: Production

    steps:
      - run: echo "ðŸŽ‰ The job was automatically triggered by a ${{ github.event_name }} event."
      - run: echo "ðŸ§ This job is now running on a ${{ runner.os }} server hosted by GitHub!"
      - run: echo "ðŸ”Ž The name of your branch is ${{ github.ref }} and your repository is ${{ github.repository }}."

      - name: Check out repository code
        uses: actions/checkout@v3
      - run: echo "ðŸ’¡ The ${{ github.repository }} repository has been cloned to the runner."
      - run: echo "ðŸ–¥ï¸ The workflow is now ready to test your code on the runner."
      - name: List files in the repository
        run: |
          ls ${{ github.workspace }}

      - uses: arwynfr/actions-docker-context@v2
        with:
          docker_host: ssh://${{ secrets.SSH_REMOTE_URL }}
          context_name: ${{ env.CONTEXT_NAME }}
          ssh_cert: ${{ secrets.SSH_CERT }}
          ssh_key: ${{ secrets.SSH_KEY }}

      - run: docker --context ${{ env.CONTEXT_NAME }} compose ps

      - name: Init .env file
        run: |
          echo "${{ secrets.APP_ENV }}" > .env
          docker --context ${{ env.CONTEXT_NAME }} compose convert

      - run: docker --context ${{ env.CONTEXT_NAME }} compose up -d
